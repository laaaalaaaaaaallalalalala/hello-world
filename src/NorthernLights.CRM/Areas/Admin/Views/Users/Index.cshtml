@{
    ViewBag.Title = "Users";
}

<h2>@ViewBag.Title</h2>

<a class="btn btn-default" href="/Admin/Users/Create" role="button">
    <span class="glyphicon glyphicon-plus"></span> Add
</a>

<table id="tableUsers" class="table table-striped" width="100%">
    <thead></thead>
    <tfoot class="filter">
        <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
        </tr>
    </tfoot>
    <tbody></tbody>
</table>

@section Scripts {
    <script>
        $(document).on('ready', function () {
            getUsers()
        })

        function getUsers() {
            $.ajax('/Admin/Users/GetUsers').done(function (data) {
                var table = $('#tableUsers').DataTable({
                    "dom": "<'row'<'col-md-12'f>><'row'<'col-md-6'i><'col-md-6'p>><'row'<'col-md-12'tr>><'row'<'col-md-6'l><'col-md-6'p>>",
                    "destroy": true,
                    "data": data,
                    "order": [[0, 'asc']],
                    "rowId": "Id",
                    "columns": [{
                        "title": "Name",
                        "render": function (data, type, row) {
                            return '<a href="/Admin/Users/Edit/' + row.Id + '">' + row.UserName + '</a>'
                        }
                    }, {
                        "title": "Email",
                        "data": "Email",
                    }, {
                        "title": "Roles",
                        "render": function (data, type, row) {
                            var html = ''
                            $.each(row.Roles, function (index, element) {
                                html += '<div>' + element.Name + '</div>'
                            })
                            return html
                        }
                    }, {
                        "orderable": false,
                        "defaultContent": '<a class="del" href="#"><span class="glyphicon glyphicon-remove"></span></a>',
                    }]
                })

                $('#tableUsers tfoot th').each(function () {
                    var title = $('#tableUsers thead th').eq($(this).index()).text()
                    if (title.length > 0) {
                        $(this).html('<input type="text" class="form-control" placeholder="Search ' + title + '">')
                    }
                });

                table.columns().eq(0).each(function (colIdx) {
                    $('input', table.column(colIdx).footer()).on('keyup change', function () {
                        table.column(colIdx).search(this.value).draw()
                    })
                })
            })
        }

        $('#tableUsers').on('click', 'a.del', function () {
            if (confirm('Are you sure?') === true) {
                var table = $('#tableUsers').DataTable()

                $.ajax({ url: '/Admin/Users/Delete/' + table.row($(this).parents('tr')).data().Id, type: 'DELETE' }).done(function () {
                    $.notify({ message: 'Data Deleted.' }, { type: 'success', placement: { from: 'top', align: 'center' } })
                    getUsers()
                })
            }
        })
    </script>
}